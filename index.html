<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>I2C basics</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
  </head>
  <body>
    <article class="language-clike">
      <section>
        <h1>I2C basics</h1>
      </section>
      <section>
        <h2>Why?</h2>
      </section>
      <section>
        <h2 class="bullet">I2C: your new best friend</h2>
        <h3 class="bullet">You essentially get precise motor motion for free.</h3>
        <h3 class="bullet">This is because I2C lets you do PID, no strings attached</h3>
        <h3 class="bullet">You can't get this kind of PID with RobotC.</h3>
      </section>
      <section>
        <h2 class="bullet">How does it work?</h2>
        <h3 class="bullet">Through the HiTechnic Motor Controller.</h3>
        <h3 class="bullet">You know, that little black box between your motor and your NXT.</h3><img src="images/motorcontroller.png" class="bullet">
        <h3 class="bullet">It also requires encoders (important!)</h3>
      </section>
      <section>
        <h2>What?</h2>
      </section>
      <section>
        <h2 class="bullet">SAAS I2C Libraries - a tour</h2>
        <h3 class="bullet">Hosted on <a href="https://github.com/saasrobotics/libraries.git">GitHub</a></h3>
        <h3 class="bullet">Embeddable in your projects via <a href="https://github.com/saasrobotics/Libraries/wiki/Adding-the-SAAS-libraries-to-your-repository">git submodules</a> - or plain old copy and paste, if not using git</h3>
        <h3 class="bullet">Layered architecture</h3>
        <h3 class="bullet"><a href="https://github.com/saasrobotics/Libraries/blob/master/I2C.h">I2C.h</a> contains the base API</h3><!-- TODO: revisit this. It will probably change soon. -->
        <h3 class="bullet"><a href="https://github.com/saasrobotics/Libraries/blob/master/Motors.h">Motors.h</a> and <a href="https://github.com/saasrobotics/Libraries/blob/master/Servos.h">Servos.h</a> are nice abstractions that work at the layer above <code>I2C.h</code>.</h3>
      </section>
      <section>
        <h2 class="bullet">Let's look at the motor API</h2>
        <h3 class="bullet">Standardized format for all functions:</h3>
        <h3 class="bullet"><!-- behold the horror. screw you, Jade. -->
          <pre><code>void I2C_FooBar(tSensors port,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int daisychainLevel,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int motorNumber,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sbyte optional)
</code></pre>
        </h3>
      </section>
      <section>
        <h2 class="bullet">Variable format</h2>
        <h3 class="bullet"><code>FooBar</code> is the function name. These are generally pretty readable.</h3>
        <h3 class="bullet"><code>port</code> is one of <code>S1</code>, <code>S2</code>, <code>S3</code>, or <code>S4</code>.</h3>
        <h3 class="bullet">Daisychains start at 1, not 0.</h3>
        <h3 class="bullet"><code>optional</code> is a function-specific value (not always used).</h3>
        <h3 class="bullet">Internal methods are prefixed with <code>_</code>. Do not use them.</h3>
      </section>
      <section data-bespoke-state="emphatic">
        <h2 class="bullet">Making a motor move</h2>
        <pre class="bullet"><code>#pragma config(Sensor, S4,     ,               sensorI2CCustom)
/* while (true) loop because the motor controller times out
after 2.5 seconds without a command */
while (true)
{
 /* set speed of motor 2, daisychain 3 on NXT port 4 to full (100) */ 
 I2C_SetMotorSpeed(S4, 3, 2, 100);
}
</code></pre>
      </section>
      <section>
        <h2 class="bullet">That's it.</h2>
      </section>
      <section data-bespoke-state="emphatic">
        <h2 class="bullet">Encoder tricks</h2>
        <pre class="bullet"><code>#pragma config(Sensor, S4,     ,               sensorI2CCustom)
while (true)
{
 /* on motor 2, daisychain 1 on NXT port 2, move to encoder position 200 */ 
 I2C_SetEncoderPosition(S2, 1, 2, 200);
}
</code></pre>
      </section>
      <section data-bespoke-state="emphatic">
        <h2 class="bullet">Moar encoder tricks: let's get fancy</h2>
        <pre class="bullet"><code>#pragma config(Sensor, S4,     ,               sensorI2CCustom)
while (true)
{
 /* set speed of motor 1, daisychain 2 on NXT port 1, 
 move exactly a half rotation based on encoders */
 I2C_SetEncoderPosition(S1, 2, 1,
  I2C_GetEncoderPosition(S1, 2, 1) + 520);
}
</code></pre>
      </section>
      <section>
        <h2>That's still it.</h2>
      </section>
      <section>
        <h2 class="bullet">Debugging</h2>
        <h3 class="bullet">Motors spinning at full speed? Check your encoders.</h3>
        <h3 class="bullet">Motors not spinning at all? Check your ports and power.</h3>
        <h3 class="bullet">Getting "3rd party driver error"? Make sure your port is set to "I2CCustom" in Motors & Sensors Setup.</h3>
      </section>
      <section>
        <h2>How?</h2>
      </section>
      <section>
        <h2 class="bullet">Anatomy of an I2C write</h2>
        <h3 class="bullet">Every request is an array of bytes: a <code>tByteArray</code></h3>
        <h3 class="bullet">Byte #1 specifies how many bytes will follow in the request (for a request of length <em>n</em> bytes byte #1 will be <em>n-1</em>). Required.</h3>
        <h3 class="bullet">Byte #2 specifies the address of the I2C device on the bus. Daisychain 1 is <code>0x02</code>, daisychain 2 is <code>0x04</code>, etc. Required.</h3>
        <h3 class="bullet">Byte #3 specifies the address on the motor controller register. Required.</h3>
        <h3 class="bullet">Byte #4 and above states the data to write to the register address. At least one required for a write.</h3>
      </section>
      <section>
        <h2 class="bullet">Byte #3</h2>
        <h3 class="bullet">A register address is basically a numbered slot in the motor controller that you can put data into</h3>
        <h3 class="bullet">If this still doesn't make sense to you, that's fine</h3>
        <h3 class="bullet">Just know that byte #3 is a magic number that determines what byte #4 means.</h3><img height="127" width="355" src="images/registertable.jpg" alt="Register address table screenshot" class="bullet">
      </section>
      <section data-bespoke-state="emphatic">
        <h2 class="bullet">Setting motor speed</h2>
        <pre><code>tByteArray I2Crequest;
/* three bytes of data follow the first byte */
I2Crequest[0] = 3;

/* device address on the I2C bus */
I2Crequest[1] = 0x02 * daisychainLevel;

/* 0x45 is the motor controller register address for motor 1 */
I2Crequest[2] = 0x45;

/* max speed is 100, max byte value is 255, so this will never overflow */
I2Crequest[3] = Speed;

writeI2C(port, I2Crequest);
</code></pre>
      </section>
      <section>
        <h2 class="bullet">Doing a read</h2>
        <h3 class="bullet">Just like doing a write, except that you don't pass any data in byte(s) 4+</h3>
        <h3 class="bullet">Instead, you pass (as arguments to <code>writeI2C()</code>) a reference to a variable which data will be stored in</h3>
      </section>
      <section data-bespoke-state="emphatic">
        <h2>Talk is cheap; show me the code!</h2>
        <pre><code>tByteArray I2Crequest;
/* this is the memory region that responses will get written to */
tByteArray I2Cresponse;

/* send 2 bytes */
I2Crequest[0] = 2;

/* send to daisychain 1 */
I2Crequest[1] = 0x02;

/* register address that, when read, returns the current encoder position of motor 1 */
I2Crequest[2] = 0x4C;

/* sends the read and writes a 4-byte response into I2Cresponse */
writeI2C(port, I2Crequest, I2Cresponse, 4);
</code></pre>
      </section>
      <section>
        <h2 class="bullet">Breaking up the bytes</h2>
        <h3 class="bullet">You can't just send a <code>long</code> or an <code>int</code></h3>
        <h3 class="bullet">You have to break it up into individual bytes</h3>
        <h3 class="bullet">You do this with bitshifting and masking</h3>
        <h3 class="bullet">I'll skip over these, since they're kind of boring.</h3>
      </section>
      <!-- TODO: uncomment this after the presentation is over-->
      <!--
      section
       h2.bullet Bitshifting & masking
       h3.bullet In a memory buffer, bitshifting shifts a certain number of bits to either the left or the right
       h3.bullet Essentially, it truncates either the left or the right
       h3.bullet However, this pulls in garbage on the other side
       h3.bullet You use masking to reset the garbage to all 0s
       
      -->
      <section data-bespoke-state="emphatic">
        <h2>Formatting for write</h2>
        <pre><code>tByteArray I2Crequest2;
I2Crequest2[0] = 6;
I2Crequest2[1] = 0x02 * daisychainLevel;
I2Crequest2[2] = 0x48;
I2Crequest2[3] = (byte)((EncoderPosition >> 24) & 0x000000ff);
I2Crequest2[4] = (byte)((EncoderPosition >> 16) & 0x000000ff);
I2Crequest2[5] = (byte)((EncoderPosition >> 8) & 0x000000ff);
I2Crequest2[6] = (byte)(EncoderPosition & 0x000000ff);
writeI2C(port, I2Crequest2);
</code></pre>
      </section>
      <section>
        <h2 class="bullet">Potential gotchas</h2>
        <h3 class="bullet">The order for power and mode is switched for motor 1 and motor 2</h3>
        <h3 class="bullet"><code>daisychain--</code>: this is to do some nice math instead of using an awful <code>switch</code> statement</h3>
      </section>
      <section>
        <h2 class="bullet">Contributing</h2>
        <h3 class="bullet">Document our APIs</h3>
        <h3 class="bullet">(We're especially interested in tutorials)</h3>
        <h3 class="bullet">Make <code>Motors.h</code> and <code>Servos.h</code> not use the no timeout bit</h3>
        <h3 class="bullet">Write a testsuite</h3>
        <h3 class="bullet">Use it. <a href="https://github.com/saasrobotics/Libraries/issues">File tickets</a> for any bugs, questions or feedback</h3>
      </section>
      <section>
        <h2 class="bullet">Contributing (II)</h2>
        <h3 class="bullet">We use the <a href="http://scottchacon.com/2011/08/31/github-flow.html">GitHub Flow</a> development methodology</h3>
        <h3 class="bullet">Talk to me afterwards if any of these items interest you.x</h3>
      </section>
      <section>
        <h2 class="bullet">Access this presentation again</h2>
        <h3 class="bullet"><a href="https://saasrobotics.com/i2c-basics">https://saasrobotics.com/i2c-basic</a></h3>
        <h3 class="bullet"><img alt="QR Code" src="images/qr.gif"></img></h3>
        <h3 class="bullet">...or get the <a href="https://github.com/saasrobotics/i2c-basics">source code</a></h3>
      </section>
      <section>
        <h2 class="bullet">Thanks!</h2>
        <h3 class="bullet">Questions?</h3>
        <h3 class="bullet">Email me at <a href="mailto:alexjordan@seattleacademy.org">alexjordan@seattleacademy.org</a></h3>
        <h3 class="bullet">Open a <a href="https://github.com/saasrobotics/Libraries/issues">GitHub issue</a></h3>
        <h3 class="bullet">Or just shout it out right now</h3>
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>